<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/bakalari-predvidac/icons/icon-512.png">
  <title>Předvídač známek</title>
  <style>
    :root { --bg:#0b1020; --panel:#121937; --muted:#95a0b8; --text:#e8eeff; --accent:#7c9cff; --ok:#35c36b; --warn:#ffc857; --err:#ff6b6b; }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1020,#0f1530 40%,#0b1020);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans",sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    h1{font-weight:800;font-size:clamp(22px,2.6vw,30px);margin:68px 0 16px;text-align:center}
    label{display:block;font-size:13px;color:#b7c2e8;margin-bottom:4px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #22306a;background:#0d1330;color:var(--text);outline:none;box-sizing:border-box}
    button{cursor:pointer;background:linear-gradient(180deg,#2a3ea1,#23348a);border:1px solid #3247c0;font-weight:700}
    .card{background:linear-gradient(180deg,#131a38,#0f1630);border:1px solid #1b254e;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:18px;margin:14px 0}

    /* Sidebar */
    .menu-btn{position:fixed;top:8px;left:8px;width:auto;background:none;border:none;font-size:24px;color:var(--text);cursor:pointer;z-index:900;display:none}
    .sidebar{position:fixed;top:0;left:-100%;width:240px;height:100%;background:#121937;border-right:1px solid #1b254e;box-shadow:4px 0 20px rgba(0,0,0,.4);padding:20px;transition:.3s;z-index:1000}
    .sidebar.open{left:0}
    .sidebar .close-btn{position: absolute;top: 8px;right: -110px;background: none;border: none;font-size: 24px;color: var(--text);cursor: pointer}
    .sidebar h2{margin:0 0 10px;font-size:18px}
    .sidebar .logout{margin-top:20px;background:#4a1623;border-color:#7a2537;width:100%}

    /* Hidden sections by default */
    #appCard{display:none}
    #loginCard{max-width:400px;margin:60px auto}

    .toast{position:fixed;bottom:14px;right:14px;background:#0d1330;border:1px solid #22306a;color:#e8eeff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 32px rgba(0,0,0,.4);opacity:0;transform:translateY(12px);transition:all .2s}
    .toast.show{opacity:1;transform:translateY(0)}

    /* tabulka a karty */
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .item{flex:1 1 200px;background:#0f1736;border:1px solid #1b2a60;border-radius:14px;padding:12px}
    .kpi .val{font-size:28px;font-weight:800}
    .hr{height:1px;background:#1a2550;margin:14px 0}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{padding:10px;text-align:left;border:1px solid #1b2a60}
    .table th{font-size:12px;color:#9fb0e0;background:#101739}
    .table td{background:#0f1736}
    .right{text-align:right}
    .btn-danger{background:#4a1623;border-color:#7a2537}

    #loginHost {padding-right: 36px}
  </style>
</head>
<body>
  <button id="menuBtn" class="menu-btn">☰</button>
  <div class="sidebar" id="sidebar">
    <button class="close-btn" id="closeSidebar">✕</button>
    <h2>Aktuální přihlášení</h2>
    <label>Adresa školy</label>
    <input id="host" placeholder="https://stav-ova.bakalari.cz/bakaweb" />
    <label>Uživatelské jméno</label>
    <input id="usernameSidebar" disabled />
    <button id="logout" class="logout">Odhlásit se</button>
  </div>

  <div class="wrap">
    <h1>Průměry a předvídač známek</h1>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <label>Adresa školy</label>
      <div style="position: relative;">
        <input id="loginHost" autocomplete="url" data-protonpass-ignore="true"
               placeholder="Vyhledat adresu..." />
        <div id="schoolDropdown" style="display:none;position:absolute;top:110%;left:0;right:0;
             max-height:260px;overflow:auto;background:#0d1330;
             border:1px solid #22306a;border-radius:12px;z-index:1000;">
          <div id="schoolList"></div>
        </div>
      </div>
      <label>Uživatelské jméno</label>
      <input id="loginUser" autocomplete="username" />
      <label>Heslo</label>
      <input id="loginPass" type="password" autocomplete="current-password" />
      <label>Použijte vaše přihlašovací údaje do systému Bakaláři.</label>
      <button id="btnLogin">Přihlásit se</button>
    </div>

    <!-- APP -->
    <div class="card" id="appCard">
      <div class="kpi">
        <div class="item"><div class="small">Předmět</div><div id="subjectTitle" class="val">—</div></div>
        <div class="item"><div class="small">Vážený průměr</div><div id="avgVal" class="val">—</div></div>
        <div class="item"><div class="small">Počet známek</div><div id="countVal" class="val">—</div></div>
      </div>

      <div class="row" style="margin-top:4px">
        <div class="col">
          <label>Vyber předmět</label>
          <select id="subjectSelect"></select>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="reload">Načíst/Obnovit</button>
        </div>
      </div>

      <div class="hr"></div>

      <table class="table" id="marksTable">
        <thead>
          <tr><th>Známka</th><th>Váha</th><th class="right">Akce</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="row">
        <div class="col">
          <label>Přidat známku do předvídače</label>
          <div class="row">
            <div class="col">
              <select id="simGrade">
                <option value="1">1</option><option value="1-">1-</option>
                <option value="2">2</option><option value="2-">2-</option>
                <option value="3">3</option><option value="3-">3-</option>
                <option value="4">4</option><option value="4-">4-</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="col">
              <select id="simWeight">
                <option>1</option><option>2</option><option>3</option>
                <option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option>
              </select>
            </div>
            <div class="col">
              <button id="addSim">Přidat</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
const $ = (id)=>document.getElementById(id);
let schools = [];

// Načti seznam škol
async function loadSchools() {
  try {
    const resp = await fetch("https://vitskalicky.gitlab.io/bakalari-schools-list/schoolsList.json");
    schools = await resp.json();
  } catch (e) {
    console.error("Nepodařilo se načíst seznam škol", e);
  }
}

// Normalizace textu (bez diakritiky a interpunkce)
function normalize(str) {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[\s,.\-]/g, "")
    .toLowerCase();
}

function renderSchools(filter="") {
  const listDiv = $("schoolList");
  listDiv.innerHTML = "";
  const f = normalize(filter);
  const filtered = schools.filter(s =>
    normalize(s.name).includes(f) || normalize(s.url).includes(f)
  );
  if (!filtered.length) {
    listDiv.innerHTML = "<div style='padding:8px;color:#95a0b8'>Žádná shoda</div>";
    return;
  }
  filtered.forEach(s => {
    const item = document.createElement("div");
    item.style.padding = "8px 10px";
    item.style.cursor = "pointer";
    item.style.borderBottom = "1px solid #1a2550";
    item.innerHTML = `<div>${s.name}</div>
                      <div style="font-size:12px;color:#95a0b8">${s.url}</div>`;
    item.onclick = () => {
      $("loginHost").value = s.url.replace(/\/$/, "");
      $("schoolDropdown").style.display = "none";
    };
    item.onmouseover = () => item.style.background="#1a2550";
    item.onmouseout  = () => item.style.background="";
    listDiv.appendChild(item);
  });
}

// Při psaní do pole Adresa školy
$("loginHost").addEventListener("input", () => {
  const val = $("loginHost").value.trim();
  if (val.length > 0) {
    $("schoolDropdown").style.display = "block";
    renderSchools(val);
  } else {
    $("schoolDropdown").style.display = "none";
  }
});

// Klik mimo dropdown = zavřít
document.addEventListener("click", (e) => {
  if (!e.target.closest("#schoolDropdown") && e.target.id!=="loginHost") {
    $("schoolDropdown").style.display = "none";
  }
});

// Načti seznam při startu
loadSchools();

    // --- zbytek kódu (toast, login, marks, app atd.) ---
    const toast=(msg)=>{const t=$('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)};
    const cfg = {host: localStorage.getItem('bk_host') || '',token: sessionStorage.getItem('bk_token') || localStorage.getItem('bk_token') || null,};
    let marksRaw = []; let subjects = []; let simulated = [];
    $('menuBtn').onclick = () => $('sidebar').classList.add('open');
    $('closeSidebar').onclick = () => $('sidebar').classList.remove('open');
    function showApp(){ $('loginCard').style.display='none'; $('appCard').style.display='block'; $('menuBtn').style.display='block'; $('usernameSidebar').value = $('loginUser').value; $('host').value = cfg.host;}
    function showLogin(){ $('loginCard').style.display='block'; $('appCard').style.display='none'; $('menuBtn').style.display='none'; $('sidebar').classList.remove('open');}
    function mapGradeTextToNumber(txt){if(!txt) return NaN;const t=String(txt).trim();if(/^\d-$/.test(t)) return parseInt(t[0])+0.5;const base=parseFloat(t.replace(',','.'));return isNaN(base)?NaN:base;}
    function weightedAverage(items){let s=0,w=0;for(const it of items){const g=typeof it.value==='number'?it.value:mapGradeTextToNumber(it.value||it.MarkText);const wt=Number(it.weight??it.Weight??1);if(!isNaN(g)&&wt>0){s+=g*wt;w+=wt;}}return w>0?(s/w):NaN;}
    function formatAvg(x){return isNaN(x)?'—':x.toFixed(2).replace('.',',');}
    function combinedMarksFor(subject){const base=marksRaw.filter(m=>m.SubjectName===subject).map(m=>({id:m.Id||(m.Date+':'+(m.Theme||'')),value:m.MarkText,weight:m.Weight??1,caption:m.Caption,text:m.Text,theme:m.Theme}));const sim=simulated.filter(x=>x.subject===subject);const map=new Map();for(const b of base) map.set(b.id,b);for(const s of sim) map.set(s.id||('sim-'+Math.random().toString(36).slice(2)),s);return Array.from(map.values());}
    function render(subject){$('subjectTitle').textContent=subject||'—';const items=subject?combinedMarksFor(subject):[];const avg=weightedAverage(items);$('avgVal').textContent=formatAvg(avg);$('countVal').textContent=String(items.length);const tbody=$('marksTable').querySelector('tbody');tbody.innerHTML='';for(const it of items){const tr=document.createElement('tr');const gradeTd=document.createElement('td');const weightTd=document.createElement('td');const actTd=document.createElement('td');actTd.className='right';const gi=document.createElement('input');gi.value=it.value;gi.style.width='70px';gi.onchange=()=>{it.value=gi.value;upsertSim(subject,it);render(subject);};const wi=document.createElement('input');wi.type='number';wi.step='1';wi.min='1';wi.value=it.weight||1;wi.style.width='60px';wi.onchange=()=>{it.weight=Number(wi.value);upsertSim(subject,it);render(subject);};gradeTd.appendChild(gi);weightTd.appendChild(wi);if(it.id&&it.id.startsWith("sim-")){const del=document.createElement('button');del.textContent='✕';del.className='btn-danger';del.onclick=()=>{removeSim(subject,it);render(subject);};actTd.appendChild(del);} else { actTd.textContent=it.caption||it.text||it.theme||""; }tr.append(gradeTd,weightTd,actTd);tbody.appendChild(tr);}}
    function upsertSim(subject,mark){if(!mark.id) mark.id='sim-'+Math.random().toString(36).slice(2);const idx=simulated.findIndex(x=>x.subject===subject&&x.id===mark.id);if(idx>=0) simulated[idx]=Object.assign({},mark,{subject}); else simulated.push(Object.assign({},mark,{subject}));localStorage.setItem('bk_sim',JSON.stringify(simulated));}
    function removeSim(subject,mark){simulated=simulated.filter(x=>!(x.subject===subject&&x.id===mark.id));localStorage.setItem('bk_sim',JSON.stringify(simulated));}
    function loadSim(){try{simulated=JSON.parse(localStorage.getItem('bk_sim')||'[]');}catch{simulated=[];}}
    async function apiFetch(url, options={}){const resp=await fetch(cfg.host+url,{...options,headers:{...(options.headers||{}),Authorization:`Bearer ${cfg.token}`}});if(!resp.ok) throw new Error(resp.status+" "+resp.statusText);return resp.json();}
    async function getToken(user,pass){const resp=await fetch(cfg.host+"/api/login",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:"ANDR",grant_type:"password",username:user,password:pass})});if(!resp.ok) throw new Error("Login failed");return resp.json();}
    async function fetchMarks(){return apiFetch("/api/3/marks");}
    async function reload(){try{const data=await fetchMarks();marksRaw=data?.Subjects?.flatMap(s=>s.Marks?.map(m=>({...m,SubjectName:s.Subject.Name}))||[])||[];const map=new Map();for(const m of marksRaw){if(!map.has(m.SubjectName))map.set(m.SubjectName,0);map.set(m.SubjectName,map.get(m.SubjectName)+1);}subjects=Array.from(map.entries()).map(([name,count])=>({name,count})).sort((a,b)=>a.name.localeCompare(b.name));const sel=$('subjectSelect');sel.innerHTML='';subjects.forEach(s=>{const o=document.createElement('option');o.value=s.name;o.textContent=`${s.name} (${s.count})`;sel.appendChild(o);});if(subjects[0]){sel.value=subjects[0].name;render(subjects[0].name);}}catch(e){toast("Chyba načítání: "+e.message);}}
    $('btnLogin').onclick=async()=>{const host=$('loginHost').value.trim();const u=$('loginUser').value.trim(),p=$('loginPass').value;if(!host||!u||!p) return toast("Vyplň všechna pole");try{cfg.host=host.replace(/\/$/,'');localStorage.setItem('bk_host',cfg.host);const data=await getToken(u,p);cfg.token=data.access_token;localStorage.setItem('bk_token',cfg.token);toast("Přihlášeno");showApp();reload();}catch(e){toast("Chyba přihlášení: "+e.message);}};
    $('logout').onclick=()=>{cfg.token=null;localStorage.removeItem('bk_token');sessionStorage.removeItem('bk_token');toast("Odhlášeno");showLogin();};
    $('reload').onclick=reload;
    $('subjectSelect').onchange=()=>render($('subjectSelect').value);
    $('addSim').onclick=()=>{const subject=$('subjectSelect').value;if(!subject)return toast("Vyber předmět");const g=$('simGrade').value;const w=Number($('simWeight').value)||1;upsertSim(subject,{id:'sim-'+Math.random().toString(36).slice(2),value:g,weight:w});render(subject);};
    loadSim();
    if(cfg.token){showApp();reload();} else {showLogin();}
  </script>
</body>
</html>
